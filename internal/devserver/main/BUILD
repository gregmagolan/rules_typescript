# Copyright 2017 The Bazel Authors. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

licenses(["notice"])  # Apache 2.0

filegroup(
    name = "source_tree",
    srcs = glob(["**/*"]),
    visibility = [
        "//internal:__subpackages__",
    ],
)

load("@io_bazel_rules_go//go:def.bzl", "go_binary")

genrule(
   name = "gen_javascript",
   outs = ["javascript.go"],
   srcs = ["@//:node_modules"],
   cmd = """
NODE_MODULES="$(locations @//:node_modules)"
REQUIRE_JS=$$(echo $$NODE_MODULES | tr ' ' '\\n' | grep "/requirejs/require.js" || true)
LIVERELOAD_JS=$$(echo $$NODE_MODULES | tr ' ' '\\n' | grep "/livereload/ext/livereload.js" || true)

if [ -z "$$REQUIRE_JS" ]; then
  >&2 echo "requirejs peer dependency required in @//:node_modules filegroup"
  exit 1
fi
if [ -z "$$LIVERELOAD_JS" ]; then
  >&2 echo "livereload peer dependency required in @//:node_modules filegroup"
  exit 1
fi

cat > $(location :javascript.go) <<EOF
// @filedescription DO NOT EDIT. THIS FILE IS AUTOMATICALLY GENERATED.
package main

const RequireJs string = \\`
EOF

cat $$REQUIRE_JS >> $(location :javascript.go)

cat <<EOT >> $(location :javascript.go)
\\`

const LivereloadJs string = \\`
EOT

cat $$LIVERELOAD_JS >> $(location :javascript.go)

cat <<EOT >> $(location :javascript.go)
\\`
// DO NOT EDIT. THIS FILE IS AUTOMATICALLY GENERATED.
EOT
""",
    stamp = 1,
)

go_binary(
    name = "main",
    srcs = ["main.go", ":gen_javascript"],
    visibility = ["//visibility:public"],
    # See https://github.com/bazelbuild/rules_go/issues/721
    importpath = "do_not_import",
    deps = [
        "//internal/concatjs",
        "//internal/devserver",
    ],
)
